<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>TestEnvironment</title>
<script src="http://localhost:8080/html-files/hintDropper.js"></script>
<script>
	
	var mileStones = [];
	var taskType = "";
	var log = "";
	var answers = "";
	var retrievalStatus = false;
	var preEvent="";
	var testId = "";
	var taskId = "";
	var entryPoint = "";
	var cookies = [];
	
	window.onload = function() {
		
		initializeCookies();
		window.document.getElementById("test").innerHTML = entryPoint;
		loadMilestones();
		loadQuizSetup();
		window.document.getElementById("monitor").contentWindow.location.replace(entryPoint);
		window.document.getElementById("monitor").addEventListener("load", access);
		setTaskType();
	};
	window.addEventListener("message", receiveMessage);
	
	
	function initializeCookies() {
		var i = 0;
		cookies = window.document.cookie.split("; ");
		for(i = 0; i < cookies.length; i++) {
			
				if(cookies[i].startsWith("testId")) {
					testId =cookies[i].split("=")[1];
				}
				if(cookies[i].startsWith("taskCounter")) {
					taskId = cookies[i].split("=")[1];
				}
				if(cookies[i].startsWith("entryPoint")) {
					var value = cookies[i].split("=")[1];
					entryPoint = value.substr(1,value.length-2);
				}if(cookies[i].startsWith("taskType")) {
					taskType = cookies[i].split("=")[1];
				}
		}
	}
	
	function loadMilestones(){
		
		var respText = "";
		var request = new XMLHttpRequest();  
	    request.onreadystatechange = function() {
	        if (this.readyState == 4 && this.status == 200) {
	        	
	        	var buf = this.responseText.split(";");
	        	var i = 0;
				for( i = 0; i < buf.length; i++) {
	    			mileStones[i]=buf[i];
	    		}
	       }
	    };
	    
		request.open("GET","http://localhost:8080/Hintservice4/hints/hint/" + testId + "/" + taskId,true);
		request.send();
	}
	
	
	function access(){
		
		var iframe = window.document.getElementById("monitor");
		var idoc = iframe.contentDocument;
		
		iframe.contentDocument.addEventListener("click",function(event){
			var ipar = iframe.contentWindow;
			var el = event.target;
			var info = event.type + " " + event.target.tagName + " " + indexOf(el, idoc.getElementsByTagName(event.target.tagName)) + " " + iframe.contentDocument.URL;
			ipar.parent.postMessage(info, entryPoint);
			document.getElementById("res").innerHTML += info;
		});
		
	}
	
	var totalTime = 0;
	var time = setInterval( clock,1000);
	var stopped = false; 
	var hintTimer = window.setInterval(displayHint,settings.hintTime);
	
		

	function clock() {
		totalTime++;
		var timeEl = window.document.getElementById("time");
		timeEl.innerHTML = totalTime;
	}

	function receiveMessage(event) {
	
		if(!stopped) {
			log += event.data + " " + totalTime + "<br>";
			recentActivity = event.data; 
			var preEventReached = (log.includes(preEvent));
			document.getElementById("test").innerHTML=retrievalStatus;
			
			
			if(log.includes(preEvent) && taskType == "RETRIEVAL") {
				document.getElementById("quizButton").style.display="block";
			}

			if( recentActivity == mileStones[mileStones.length -1] && retrievalStatus ) {
				
				finishTest();
			} else {
				
				var effectiveStage = mileStones.findIndex(recentActivity);
				if( effectiveStage > currentStage) {
					currenStage = effectiveStage + 1;
					clearInterval(hintTimer);
					hintTimer = setInterval(displayHint,settings.hintTime);
					document.getElementById("hint").style.display = "none";
				}  
			}
		}
	}
	
	function cancelTask() {
		
		log  +="<br>" + 
		 "click " + "cancel " + "0 " + " - " + totalTime;
		document.cookie = "finishStatus=cancelled;path=/";
		sendData();
		window.location.replace("http://localhost:8080/PTT2/finish");

	}
	
	function stop(){
		clearInterval(time);
		document.getElementById("pause-btn").innerHTML = "continue";
		document.getElementById("pause-btn").setAttribute("onclick","cont()");
		stopped = true; 
	}
	
	function cont(){
		time = setInterval(clock, 1000);
		document.getElementById("pause-btn").innerHTML = "pause";
		document.getElementById("pause-btn").setAttribute("onclick","stop()");
		stopped = false;
		
	}
	
	function displayHint(){
		if(!checkMilestones() && !trailDone) {
			document.getElementById("hint").style.display = "block";
		}
	}
	
	function giveHint(){
		alert(this.mileStones[currentStage]);
	}
	
	function sendData(){
		var request = new XMLHttpRequest(); 
		request.open("POST","http://localhost:8080/PTT2/save",false);
		request.send(log);
	}
	
	function indexOf( element, nList) {
		var i = 0;
		var res = 0;
		for(i = 0; i < nList.length; i++){
			if(nList[i].isEqualNode(element)){
				res = i;
			} 
		}
		return res;
	}
	
	function setTaskType() {
		var i = 0;
		for( i = 0; i < cookies.length; i++) {
			if(cookies[i].startsWith("taskType")) {
				taskType = cookies[i].split("=")[1];
				break;
			}
		}
		
		if(taskType == "RETRIEVAL") {
			retrievalStatus = false;
		} else {
			retrievalStatus = true; 
		}
	}
	
	
	function loadQuizSetup() { 
		
		var request = new XMLHttpRequest();  
	    request.onreadystatechange = function() {
	        if (this.readyState == 4 && this.status == 200) {
	        	document.getElementById("quizForm").innerHTML  = this.responseText + 
				"<button onclick=\"checkConstraints()\" >check answers</button>";
	       }
	    };
	    
		request.open("GET","http://localhost:8080/QuestionService/service/get/questions/" 
		+ testId + "/" + taskId,true);
		request.send();
		
		var request2 = new XMLHttpRequest();  
	    request2.onreadystatechange = function() {
	        if (this.readyState == 4 && this.status == 200) {
	    			answers+=this.responseText;
	       }
	    };
	    
		request2.open("GET","http://localhost:8080/QuestionService/service/get/answers/" 
		+ testId + "/" + taskId,true);
		request2.send();
		document.getElementById("test").innerHTML = answers;
		var request3 = new XMLHttpRequest();  
	    request3.onreadystatechange = function() {
	        if (this.readyState == 4 && this.status == 200) {
				preEvent += this.responseText;
	       }
	    };  
		request3.open("GET","http://localhost:8080/QuestionService/service/get/preEvent/" 
		+ testId + "/" + taskId,true);
		request3.send();
			setTaskType();
		
	}
	
	function showQuiz() {
		document.getElementById("quizPopup").style.display="block";
		document.getElementById("quizPopup").style.position="absolute";
		document.getElementById("quizPopup").style.zIndex="1";
		document.getElementById("quizPopup").style.height="500px";
		document.getElementById("quizPopup").style.backgroundColor="white";
		document.getElementsByTagName("body")[0].style.zIndex="0";
	}
	function closeQuiz() {
		document.getElementById("quizPopup").style.display="none";
	}
	
	var help = ""; 
	function checkConstraints(){
		
		var result =true;
		var counter = 0;
		var ans = answers.split(";");
		document.getElementById("err").innerHTML = "";
		for( counter; counter < ans.length; counter++) {
			help = "q" + counter;
			
			var x = document.getElementById(help).value ;
			
			if(x != ans.find(checkCondition).split(":")[1]) {
				document.getElementById("err").innerHTML += " Wrong answer to question " 
				+ (counter + 1) + ".";
				result &= false;
			} else {
				result &= true;
			}
			
		}
		
		if(result) {
			finishTest();
		}
		
	}
	
	function checkCondition(element) {
		return element.startsWith(help);
	}
	
	function finishTest() {  
				trailDone = true;
				clearInterval(hintTimer);  
				document.getElementById("hint").style.display = "none";
				sendData();
				document.cookie = "finishStatus=completed;path=/";
				window.location.replace("http://localhost:8080/PTT2/finish");
	}
	
	
</script>
</head>
<body>
<iframe  id="monitor" height="1000" width="1000">
</iframe>
<button id="pause-btn" onclick="stop()">pause</button>
<button id="cancel" onclick="cancelTask()">cancel</button>
<button id="hint" onclick="giveHint()" style="display:none">hint</button>
<button class="quiz" id="quizButton" onclick="showQuiz()" style="display:none">finish test</button>
<div class="quiz" id="quizPopup" style="display:none">
	<div id="quizForm" >
	
	</div>
	<p id="err"></p>
	<button onclick="closeQuiz()"> back </button>
	
</div>
<p id="time">0</p>
<p id="res" style="overflow: scroll; height:100px; width:300px;"></p>
<p id="test"></p>
<p>hi</p>

</body>
</html>